# SMзегезнең SMTP почта җибәрү серверын төзегез

## преамбула

SMTP турыдан-туры болыт сатучылардан хезмәтләр сатып ала ала, мәсәлән:

* [Amazon SES SMTP](https://docs.aws.amazon.com/ses/latest/dg/send-email-smtp.html)
* [Али болыт электрон почтасы](https://www.alibabacloud.com/help/directmail/latest/three-mail-sending-methods)

Сез шулай ук ​​үзегезнең почта серверын төзи аласыз - чикләнмәгән җибәрү, гомуми бәя аз.

Түбәндә, без үзебезнең почта серверын ничек төзергә икәнен адым саен күрсәтәбез.

## Сервер сайлау

Selfз-үзен урнаштырган SMTP серверы 25, 456, 587 портлары булган ачык IP таләп итә.

Гадәттә кулланыла торган җәмәгать болытлары бу портларны килешү буенча блокладылар, һәм аларны эш заказы белән ачып була, ләкин бу бик авыр.

Бу портлар ачык булган һәм кире домен исемнәрен куярга ярдәм итүче хуҗадан сатып алырга киңәш итәм.

Монда мин [Контабога](https://contabo.com) тәкъдим итәм.

Contabo - хостинг провайдеры, Германиянең Мюнхен шәһәрендә, 2003-нче елда бик конкурент бәяләр белән оешкан.

Әгәр сез евро сатып алу валютасы итеп сайласагыз, бәя арзанрак булачак (8 ГБ хәтерле сервер һәм 4 үзәк эшкәрткеч җайланма елына якынча 529 юань тора, һәм башлангыч урнаштыру бәясе бер ел бушлай).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/UoAQkwY.webp)

Заказ урнаштырганда, искәрмә `prefer AMD` , һәм AMD үзәк эшкәрткеч җайланмасы булган сервер яхшырак эшләячәк.

Түбәндә, мин үзегезнең почта серверын ничек төзергә икәнен күрсәтү өчен, Contabo's VPSны мисал итеп алырмын.

## Ubuntu системасы конфигурациясе

Мондагы операцион система - Ubuntu 22.04

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/smpIu1F.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/m7Mwjwr.webp)

Ssh серверы `Welcome to TinyCore 13!` (астагы рәсемдә күрсәтелгәнчә), бу система әле урнаштырылмаган дигән сүз. Зинһар, ssh-ны өзегез һәм яңадан керү өчен берничә минут көтегез.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/-qKACz9.webp)

`Welcome to Ubuntu 22.04.1 LTS` , инициализация тәмамланды, һәм сез түбәндәге адымнар белән дәвам итә аласыз.

### [Ихтимал] developmentсеш мохитен башлау

Бу адым факультатив.

Уңайлык өчен, мин [github.com/wactax/ops.os/tree/main/ubuntu'ка](https://github.com/wactax/ops.os/tree/main/ubuntu) ubuntu программасын урнаштыру һәм система конфигурациясен куйдым.

Бер басу белән урнаштыру өчен түбәндәге боерыкны эшләгез.

```
bash <(curl -s https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

Кытай кулланучылары, зинһар, түбәндәге боерыкны кулланыгыз, һәм тел, вакыт зонасы һ.б. автоматик рәвештә урнаштырылачак.

```
CN=1 bash <(curl -s https://ghproxy.com/https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

### Contabo IPV6 мөмкинлеген бирә

IPV6 кушыгыз, шулай итеп SMTP IPV6 адреслары белән электрон почталар җибәрә ала.

`/etc/sysctl.conf` үзгәртү

Түбәндәге юлларны үзгәртегез яки өстәгез

```
net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0
```

[Контабо кулланмасы белән эшләгез: Сезнең серверга IPv6 тоташу өстәү](https://contabo.com/blog/adding-ipv6-connectivity-to-your-server/)

`/etc/netplan/01-netcfg.yaml` редакцияләгез, астагы рәсемдә күрсәтелгәнчә берничә юл өстәгез (Contabo VPS килешү конфигурациясе файлында бу сызыклар бар, алардан башка).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/5MEi41I.webp)

Аннары `netplan apply` .

Конфигурация уңышлы булганнан соң, сез тышкы челтәрнең ipv6 адресын карау өчен `curl 6.ipw.cn` куллана аласыз.

## Конфигурация складларын клонлагыз

```
git clone https://github.com/wactax/ops.soft.git
```

## Сезнең домен исемегез өчен бушлай SSL сертификаты булдырыгыз

Почта җибәрү шифрлау һәм кул кую өчен SSL сертификаты таләп итә.

Сертификатлар ясау өчен [acme.sh](https://github.com/acmesh-official/acme.sh) кулланабыз.

acme.sh - ачык чыганаклы автоматлаштырылган сертификатка кул кую коралы,

Ops.soft конфигурация складын кертегез, `./ssl.sh` эшләгез, һәм **өске каталогта** `conf` папка булдырылачак.

[Acme.sh dnsapi'тан](https://github.com/acmesh-official/acme.sh/wiki/dnsapi) DNS провайдерыгызны табыгыз, `conf/conf.sh` редакцияләгез.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Qjq1C1i.webp)

Аннары сезнең домен исемегез өчен `123.com` һәм `*.123.com` сертификатларын булдыру өчен `./ssl.sh 123.com` эшләгез.

Беренче йөгереш автоматик рәвештә [acme.sh](https://github.com/acmesh-official/acme.sh) урнаштырачак һәм автоматик яңарту өчен планлаштырылган бирем өстәячәк. Сез `crontab -l` күрә аласыз, түбәндәгечә шундый сызык бар.

```
52 0 * * * "/mnt/www/.acme.sh"/acme.sh --cron --home "/mnt/www/.acme.sh" > /dev/null
```

Генерацияләнгән сертификат өчен юл `/mnt/www/.acme.sh/123.com_ecc。` like кебек

Сертификатны яңарту `conf/reload/123.com.sh` скрипты дип аталачак, бу сценарийны үзгәртә, сез бәйләнешле кушымталарның сертификат кэшын яңарту өчен `nginx -s reload` кебек боерыклар өсти аласыз.

## SMTP серверын часкид белән төзегез

[chasquid](https://github.com/albertito/chasquid) - Go телендә язылган ачык чыганак SMTP серверы.

Борыңгы почта серверы Постфикс һәм Sendmail кебек программаларны алыштыручы буларак, chasquid гадирәк һәм куллану җиңелрәк, һәм икенчел үсеш өчен дә җиңелрәк.

Йөгерегез `./chasquid/init.sh 123.com` бер басу белән автоматик рәвештә урнаштырылачак (123.com җибәрү домен исеме белән алыштырыгыз).

## Электрон почта имзасын конфигурацияләгез DKIM

DKIM хатларга спам кебек каралмасын өчен электрон почта имзаларын җибәрү өчен кулланыла.

Команда уңышлы эшләгәннән соң, сезгә DKIM рекорды куярга соралачак (аста күрсәтелгәнчә).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/LJWGsmI.webp)

DNS-ка TXT язмасын өстәгез (аста күрсәтелгәнчә).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/0szKWqV.webp)

## Хезмәт статусын һәм журналларны карау

 `systemctl status chasquid` Хезмәт статусын карау.

Нормаль эшнең торышы түбәндәге рәсемдә күрсәтелгәнчә

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/CAwyY4E.webp)

 `grep chasquid /var/log/syslog` яки `journalctl -xeu chasquid` хата журналын карый ала.

## Кире домен исеме конфигурациясе

Кире домен исеме - IP адресны тиешле домен исеменә чишәргә рөхсәт итү.

Кире домен исемен кую электрон почталарны спам дип танырга комачаулый ала.

Почта кабул ителгәч, кабул итүче сервер җибәрүче серверның IP-адресында кире домен исемен анализлаячак, җибәрүче серверның кире домен исеме барлыгын раслау өчен.

Әгәр җибәрүче серверның кире домен исеме булмаса яки кире домен исеме җибәрүче серверның IP адресына туры килмәсә, кабул итүче сервер электрон почтаны спам дип танырга яки кире кагарга мөмкин.

[Https://my.contabo.com/rdns](https://my.contabo.com/rdns) сайтына керегез һәм аста күрсәтелгәнчә конфигурацияләгез

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/IIPdBk_.webp)

Кире домен исемен куйганнан соң, серверга ipv4 һәм ipv6 домен исеменең алга резолюциясен конфигурацияләргә онытмагыз.

## Chasquid.conf хост исемен үзгәртү

`conf/chasquid/chasquid.conf` кире домен исеменең кыйммәтенә үзгәртегез.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/6Fw4SQi.webp)

Аннары сервисны яңадан башлау өчен `systemctl restart chasquid` эшләгез.

## Гит репозитариясенә резерв резерв

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Fier9uv.webp)

Мисал өчен, мин папканы үземнең github процессына түбәндәгечә резервлыйм

Башта шәхси склад булдырыгыз

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ZSCT1t1.webp)

Conf каталогына керегез һәм складка җибәрегез

```
git init
git add .
git commit -m "init"
git branch -M main
git remote add origin git@github.com:wac-tax-key/conf.git
git push -u origin main
```

## Enderибәрүче өстәгез

йөгер

```
chasquid-util user-add i@wac.tax
```

Enderибәрүче өсти ала

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/khHjLof.webp)

### Серсүзнең дөрес куелганын тикшерегез

```
chasquid-util authenticate i@wac.tax --password=xxxxxxx
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/e92JHXq.webp)

Кулланучыны өстәгәннән соң, `chasquid/domains/wac.tax/users` яңартылачак, аны складка җибәрергә онытмагыз.

## DNS SPF язмасын өсти

SPF (җибәрүче политикасы) - электрон почтаны алдау өчен кулланылган электрон почта тикшерү технологиясе.

Бу почта җибәрүченең шәхесен тикшерүче IP-адресы домен исеменең DNS язмаларына туры килүен тикшереп, мошенникларның ялган электрон почталар җибәрүенә юл куймый.

SPF язмаларын өстәү электрон почталарны мөмкин кадәр спам дип танырга комачаулый ала.

Әгәр сезнең домен исем серверыгыз SPF төрен хупламаса, TXT тибындагы язуны өстәгез.

Мәсәлән, `wac.tax` SPF түбәндәгечә

`v=spf1 a mx include:_spf.wac.tax include:_spf.google.com ~all`

`_spf.wac.tax` өчен SPF

`v=spf1 a:smtp.wac.tax ~all`

Игътибар итегез, мин монда `include:_spf.google.com` , чөнки мин `i@wac.tax` соңрак Google почта тартмасына җибәрү адресы итеп конфигурацияләячәкмен.

## DNS конфигурациясе DMARC

DMARC - кыскарту (Домен нигезендә хәбәрне раслау, отчет һәм конформация).

Бу SPF сикерүләрен кулга алу өчен кулланыла (бәлки конфигурация хаталары аркасында килеп чыккандыр, яисә бүтән кеше сезне спам җибәргән кебек тота).

TXT рекордын өстәгез `_dmarc` ,

Эчтәлек түбәндәгечә

```
v=DMARC1; p=quarantine; fo=1; ruf=mailto:ruf@wac.tax; rua=mailto:rua@wac.tax
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/k44P7O3.webp)

Eachәр параметрның мәгънәсе түбәндәгечә

### р (политика)

SPF (җибәрүче политикасы) яки DKIM (DomainKeys Identified Mail) тикшерүен уңышсыз калдырган электрон почталарны ничек эшләргә икәнен күрсәтә. P параметрын өч кыйммәтнең берсенә куярга мөмкин:

* берсе дә: бернинди чара күрелми, тикшерү нәтиҗәләре генә җибәрүчегә электрон почта хәбәр итү механизмы аша кайтарыла.
* Карантин: Тикшерүне узмаган хатны спам папкасына куегыз, ләкин почтаны турыдан-туры кире кагмассыз.
* кире кагу: Тикшерү уңышсыз булган электрон почталарны турыдан-туры кире кагу.

### fo (Уңышсызлык вариантлары)

Хисап механизмы белән кайтарылган мәгълүмат күләмен күрсәтә. Аны түбәндәге кыйммәтләрнең берсенә куярга мөмкин:

* 0: Барлык хәбәрләр өчен тикшерү нәтиҗәләрен хәбәр итегез
* 1: Тикшерү уңышсыз булган хәбәрләр турында хәбәр итегез
* г: Домен исемен тикшерү уңышсызлыклары турында гына хәбәр итегез
* s: бары тик SPF тикшерү уңышсызлыклары турында хәбәр итегез
* l: DKIM тикшерү уңышсызлыклары турында гына хәбәр итегез

### rua & ruf

* rua (Агрегат отчетлары өчен URI отчеты): Агрегатлы отчетлар алу өчен электрон почта адресы
* ruf (Суд-отчет өчен URI отчеты): җентекле докладлар алу өчен электрон почта адресы

## Google Mail'ка электрон почталар җибәрү өчен MX язмаларын өстәгез

Мин универсаль адресларны хуплый торган бушлай корпоратив почта ящикын таба алмадым (Catch-All, бу домен исеменә җибәрелгән электрон почталарны префиксларга чикләүләрсез ала ала), мин барлык электрон почталарны Gmail почта тартмасына җибәрү өчен шаскид кулландым.

**Әгәр сезнең түләүле бизнес почта тартмагыз булса, зинһар, MXны үзгәртмәгез һәм бу адымны калдырмагыз.**

`conf/chasquid/domains/wac.tax/aliases` үзгәртү, почта тартмасын җибәрү

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/OBDl2gw.webp)

`*` барлык электрон почталарны күрсәтә, `i` югарыда җибәрелгән кулланучының электрон почта адресы префиксы. Почта җибәрү өчен, һәр кулланучыга сызык өстәргә кирәк.

Аннары MX язмасын өстәгез (мин астагы рәсемнең беренче юлында күрсәтелгәнчә, монда кире домен исеменең адресына күрсәтәм).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/7__KrU8.webp)

Конфигурация тәмамланганнан соң, сез бүтән электрон почта адресларын кулланып, `i@wac.tax` һәм `any123@wac.tax` электрон почталарын җибәрә аласыз, Gmail'да электрон почталар ала аласызмы.

Notк икән, часкид журналын тикшерегез ( `grep chasquid /var/log/syslog` ).

## Google Mail белән i@wac.tax электрон почтасын җибәрегез

Google Mail почтаны алганнан соң, мин i.wac.tax@gmail.com урынына `i@wac.tax` белән җавап бирергә өметләндем.

[Https://mail.google.com/mail/u/1/#settings/accounts](https://mail.google.com/mail/u/1/#settings/accounts) сайтына керегез һәм "Башка электрон почта адресын өстәү" төймәсенә басыгыз.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/PAvyE3C.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/_OgLsPT.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/XIUf6Dc.webp)

Аннары, җибәрелгән электрон почта аша алынган тикшерү кодын кертегез.

Ниһаять, аны җибәрүче адрес итеп куярга мөмкин (шул ук адрес белән җавап бирү варианты белән бергә).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/a95dO60.webp)

Шул рәвешле, без SMTP почта серверын булдыруны тәмамладык һәм шул ук вакытта электрон почта җибәрү һәм алу өчен Google Mail кулланабыз.

## Конфигурациянең уңышлы булу-булмавын тикшерү өчен тест электрон почтасы җибәрегез

`ops/chasquid` кертегез

Run `direnv allow` (direnv алдагы бер ачкыч инициализация процессында урнаштырылган һәм кабыкка калька өстәлгән).

аннары йөгерегез

```
user=i@wac.tax pass=xxxx to=iuser.link@gmail.com ./sendmail.coffee
```

Параметрларның мәгънәсе түбәндәгечә

* кулланучы: SMTP кулланучы исеме
* pass: SMTP серсүз
* өчен: алучы

Сез тест электрон почтасын җибәрә аласыз.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ae1iWyM.webp)

Конфигурацияләрнең уңышлы булу-булмавын тикшерү өчен Gmail-ны сынау хатлары алу өчен кулланырга киңәш ителә.

### TLS стандарт шифрлау

Түбәндәге рәсемдә күрсәтелгәнчә, бу кечкенә йозак бар, димәк, SSL сертификаты уңышлы кушылган.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/SrdbAwh.webp)

Аннары "Оригиналь электрон почтаны күрсәт" төймәсенә басыгыз

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/qQQsdxg.webp)

### DKIM

Түбәндәге рәсемдә күрсәтелгәнчә, Gmail оригиналь почта битендә DKIM күрсәтелә, бу DKIM конфигурациясе уңышлы дигән сүз.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/an6aXK6.webp)

Алынган электрон почта башында алынганны тикшерегез, һәм сез җибәрүче адресның IPV6 булуын күрә аласыз, димәк IPV6 шулай ук ​​уңышлы конфигурацияләнгән.
